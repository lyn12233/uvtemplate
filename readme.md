# UVProject Template

- template targeting board stm32f10x generated by stm32cubemx 
- testing on uvhelper: to gen stub file for hinting

> below is a description on stm32f103xe dev

## basic knowledge

### nomenclature

- AHB: advanced high-performance bus
- AIRCR: application interrupt/reset control register (c inst)
- APB: advanced pci bridge
- CMSIS: common microcontroller software interface standard
- DCD: define constant dword (asm)
- GPIO: general purpose IO
- HAL: hardware abstract level
- HSE: high-speed external crystal
- HSI: high-speed internal crystal
- NMI: non maskable interrupt
- NVIC: embedded vector interrupt register
- PendSV: pendable services
- PLL: phase lock loop
- RCC: reset and clock control
- SCB: system control block (c inst)
- UEV: update event
- UIF: update interrupt flag


### hardware info

cortex-m3 core component:
    1. cm3 core(cpu, based on armv7 core)
    2. NVIC: embedded vector interrupt controller
    3. systick: 24bit counter
    4. MPU: memory protection unit
    5. bus matrix?

registers in arm instruction set:
    1. r0-r11
    2. r12: IP (intra-procedure call scratch, for caller-saved calling convention)
    3. r13: MSP (stack pointer)
    4. r14: LR (link register)
    5. r15: PC (program counter)
    6. xPSR state register
    7. PRIMASK, FAULTMASK, BASEPRI: interrupt registers
    8. CONTROL

modes in arm instruction set:
    1. arm
    2. thumb: compact 16-bit mode

stm32 pins:
 - power
 - oscillator
 - reset/download/boot
 - gpio

cm3 structure:
    1. cpu->code bus->flash/sram
    2. cpu->sysbus->AHB(advanced high-performance bus?)->RAM
    3. cpu->sysbus->APB(advanced pci bridge)->IO/UART

storage:

stm32 naming:

- F: general purpose
- 101/102/103/105: basic/usb/enhanced/connected
- T/C/R/V/Z: 36pin/48pin/64pin/100pin/144pin
- 4/6/8/B/C/D/E: 16K/32K/64K/128K/256K/384K/512K flash
- ..

### start schedules

- board setup
  - entry: startup_xxx.s
    - defines stack: Stack_Mem - __initial_sp
    - defines heap: __heap_base - Heap_Mem - __heap_limit
    - defines interrupt vector: __Vectors - ... - __Vectors_End
    - impl reset_handler: calls SystemInit and __main. [ WEAK ] means to be overridden
    - impl NMI, SVC, PendSV handlers, fault handlers and irq handlers
    - directly load stackheap info to registers
  - SystemInit() in system_xxx.c: currently nop
  - main() in main.c: hal_init, clock config, user initors and mainloop
    - HAL_Init: initor for HAL lib
      - NVIC: set priority grouping to '4'; writes to SBC->AIRCR reg VECTKEY and PRIGROUP fields [see also](https://blog.csdn.net/fzf1996/article/details/97815100)
      - NVIC: set systick priority to 15.0
      - MSP init to be overridden
    - SystemClockConfig
      - rcc: oscillator init: activate and use HSI, PLL not config'd
      - rcc: clock config: for HCLK, SYSCLK, PCLK1/2, clock source from HSI, AHB and APB divider as default
- GPIO setup
  - __HAL_RCC_GPIOx_CLK_ENABLE: set RCC->APB2ENR with xxx_PxEN and wait reg update(read it)
  - HAL_GPIO_Init: with GPIOx and init info(pin, mode, speed)
- TIM(timer) setup
  - __HAL_RCC_TIM4_CLK_ENABLE: ser RCC->APB1ENR with xxx_TIMxEN
  - HAL_TIM_Base_Init: with TIMx and init info(period, prescaler, division, count_mode)
    - TIM_Base_SetConfig
    - set states to ready
  - HAL_TIM_Base_Start: 
    - __HAL_TIM_ENABLE: set ->CR1 segment to enable

### GPIO

#### mode
- in floating
- input pull up (IPU)
- input pull down (IPD)
- analog in (AIN)
- (out / alternate function(AF)) (open drain(OD) / pull-push(PP))
#### speed
in stm32: 2M(serial), 10M(IIC), 50M(SPI)
#### types and functions:

GPIO_InitTypeDef, GPIO_PIN_x, GPIO_MODE_x, GPIO_SPEED_x, __HAL_RCC_GPIOx_CLK_ENABLE HAL_GPIO_Init(), HAL_GPIO_(Write/Toggle/Read)Pin,...

> to lit LED, scheme shows that LED0--PB5 means GPIOB pin5

### timers
#### common timer modes:
- regular
- pwm output
- input mode
#### timers in stm
- TIM6-7(basic)
- TIM2-5(general)
- TIM1,TIM8(advanced)
> need more info

#### timer registers
- xxx_CRx(control reg)
- xxx_DIER(DMA interrupt enabler reg)
- xxx_SR(state reg)
- xxx_EGR(event generator reg)
- xxx_CNT
- xxx_ARR(auto reload reg)
- xxx_PSC(prescaler)
for general regs:
- xxx_CCR(capture-compare reg)
#### timer clock sources
CK_INT(internal), TIx(toggle input), ETR(external toggle), ITRx(internal toggle)
#### timer behavior

### transplanting FreeRTOS
> this focuses on single-process stm32f103ze freertos transplantation

freertos requires hardware specific files, including:
 - FreeRTOSConfig.h for config
   - CPU_CLOCK_HZ, TICK_RATE_HZ, 
   - TOTAL_HEAP_SIZE, MINIMAL_STACK_SIZE
   - ...
 - port.c for port layer
   - ...
 - heap_x.c choose heap scheme
 - board.c for peripheral setup

files provided by freertos kernel:
 - croutine.c: coroutine implementation, not suggested in 32-bit mcu
 - list.c
 - queue.c
 - stream_buffer.c
 - tasks.c
 - timers.c
 - /include
   - xxx.h corresponding to xxx.c 
   - FreeRTOS.h: structs for list_item, list, queue, event_group, timer, stream_buffer, etc.
 - /portable/GCC/ARM_CM3/
   - port.c
   - portmacro.h

## description of file layout:

- ./core: startup entry, main entry, and system ctors
  - inc
  - src
    - main.c: main loop
    - startup_< stm version >.s: init stack and instruction pointers,...

- ./drivers/CMSIS: software interface
  - device/st/stm32f1xx/include
    - stmxxx.h: defines IRQn names, peripheral device structs, etc
    - system_stmxxx.h: exports core_clock,AHB/APB table structs; system_init() and system_clock_update() functions.
  - include
    - cmsis_< compiler >.h: for compiler compatibility
    - core_cmx.h: defines PSR types, NVIC struct,  NVIC access functions, etc (unused?)

- ./drivers/STM32F1xx_HAL_Driver: HAL lib
  - inc
  - src

### include hierachy